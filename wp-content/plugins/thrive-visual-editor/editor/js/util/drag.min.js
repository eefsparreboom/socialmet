var TVE_Content_Builder=TVE_Content_Builder||{};(function(c){var j=".thrv_wrapper, p:not(.edit_mode, .thrv_custom_html_shortcode p, .wp-caption p), ul:not(ul.tve_clearfix), ol, h1, h2, h3, h4, h5, h6, address, pre, blockquote",b=".tve_no_drag, .tve_faqB *, .tve_wp_shortcode *, .thrv_bullets_shortcode ul, .thrv_tw_qs *, .thrv_post_grid *, .thrv_custom_html_shortcode *, .thrv_widget *",g=".tve_colm, .tve_colm .tve_grt, .tve_cb div:not(.thrive-shortcode-config,.tve_dropzone), .tve_faqC, td, th, .fwi, .tve_content_inner, .thrv_content_reveal, .tve_scTC, .cck, .tve_empty_dropzone",a='<div class="tve_dropzone"></div>',h=null,i=null,f=(navigator.userAgent.toLowerCase().indexOf("msie")!=-1)?parseInt(navigator.userAgent.toLowerCase().split("msie")[1]):false,d=null,e=function(l,m,n){if(l.addEventListener){l.addEventListener(m,n,false)}else{if(l.attachEvent){l.attachEvent("on"+m,function(o){if(!o){o=window.event}return n.call(l,o)})}}},k={init:function(){d=this.page_scroll(TVE_Content_Builder.config.post_type==="tcb_lightbox"?"#tve-p-scroller":"body");TVE_Editor_Page.editor.find(j).not(b).addClass("tve_draggable").attr("draggable","true").each(function(){k.make_draggable(this)});c("#tve_cpanel").on("click",".cp_draggable",function(){TVE_Editor_Page.enable();k.fetch(c(this),k.get_dropzone())});c(".cp_draggable").attr("draggable","true").each(function(){k.make_draggable(this)});this.drop_forbid=c(".tve_drop_constraint");this.refresh();var l=c("body");l.on("mousemove",function(){if(l.hasClass("tve-dragging")){l.removeClass("tve-dragging")}})},get_dropzone:function(){var m=c(".edit_mode"),o=c("#tve_editor");if(m.length!==0){return m.nextAll(".tve_dropzone").first()}var l=o.find(".tve_editor_main_content");if(l.length===0){l=o}var n=l.first().children(".tve_dropzone");if(n.length){return n.last()}l.first().append('<div class="tve_dropzone" style="height:0px"></div>');return l.children(".tve_dropzone").last()},dragstart:function(n){var m=c(this),l=m.attr("data-elem");if(c(".edit_mode").length){n.preventDefault&&n.preventDefault();return false}if(n.stopPropagation){n.stopPropagation()}h=m.addClass("tve-dragged");i=h.nextAll(".tve_dropzone").first();setTimeout(function(){c("body").addClass("tve-dragging")},20);k.drop_forbid.removeClass("tve_drop_forbidden").each(function(){var o=c(this);if(h.is(o.attr("data-forbid"))){o.addClass("tve_drop_forbidden")}});n.dataTransfer.effectAllowed="copy";n.dataTransfer.setData("Text",l?l:("some_unique_id"+Math.random().toString()))},dragend:function(){c("body").removeClass("tve-dragging");c(this).removeClass("tve-dragged");h=null;d.hide()},dragenter:function(){c(this).addClass("tve_dragged_over")},dragover:function(l){if(l.preventDefault){l.preventDefault()}l.dataTransfer.dropEffect="copy";return false},dragleave:function(){c(this).removeClass("tve_dragged_over")},drop:function(m){var l=c(this);m.stopPropagation&&m.stopPropagation();m.preventDefault&&m.preventDefault();c("body").removeClass("tve-dragging");h.removeClass("tve-dragged tve-draggable");d.hide();if(h.is("#tve_cpanel .cp_draggable")){k.fetch(h,l)}else{if(l.is(c(".tve_dropzone",h))){l.removeClass("tve_dragged_over");return false}l.removeClass("tve_dragged_over");tve_set_window_content_before_action();if(i&&!(i.is(l))){i.remove()}l.replaceWith(h);k.ensure_dropzones(h);tve_set_window_content_after_action()}h=null;return false},bind_draggable:function(l){l.filter(j).not(b).addClass("tve_draggable").attr("draggable","true").each(function(){k.make_draggable(this)});l.find(j).not(b).addClass("tve_draggable").attr("draggable","true").each(function(){k.make_draggable(this)})},make_draggable:function(l){e(l,"dragstart",k.dragstart);e(l,"dragend",k.dragend);if(f){e(l,"selectstart",function(m){if(c(".edit_mode").length){return true}m.preventDefault&&m.preventDefault();m.stopPropagation&&m.stopPropagation();this.dragDrop&&this.dragDrop();return false})}},refresh:function(l){if(typeof l==="undefined"){l=false}if(l){c("#tve_editor").find(j).not(b).addClass("tve_draggable").attr("draggable","true").each(function(){k.make_draggable(this)})}this.dropzones();c(".tve_dropzone").each(function(){k.dropzone_events(this)})},dropzone_events:function(l){if(l.jquery){l=l[0]}e(l,"dragenter",this.dragenter);e(l,"dragover",this.dragover);e(l,"dragleave",this.dragleave);e(l,"drop",this.drop)},dropzones:function(){var l=c("#tve_editor").css("min-height",TVE_Editor_Page.editor.height()+"px");c(".tve_dropzone").remove();l.find(j).not(b).each(function(){var m=jQuery(this).after(a);if(m.is(":first-child")||!m.prev().is(":visible")){m.before(a)}});l.find(g).each(function(){var m=c(this);if(!c.trim(m.text())&&m.children(":visible").length===0){m.append(a)}});if(l.find("*:visible").length===0){l.append(a)}l.css("min-height","");l=null},ensure_dropzones:function(l){if(!l.next().is(".tve_dropzone")){l.after(a);k.dropzone_events(l.next())}if(!l.prev().is(".tve_dropzone")){l.before(a);k.dropzone_events(l.prev())}l.find(j).not(b).each(function(){var m=c(this);if(!m.prev().is(".tve_dropzone")){m.before(a);k.dropzone_events(m.prev())}if(!m.next().is(".tve_dropzone")){m.after(a);k.dropzone_events(m.next())}})},fetch:function(l,o){var m=l.find("input").serializeArray(),n=l.attr("data-elem");if(this.before_fetch(n,l,o)===false){return false}if(c.inArray(n+".php",TVE_Content_Builder.config.shortcodes_array)===-1){return false}if(l.attr("data-overlay")){TVE_Editor_Page.overlay()}m.push({name:"colour",value:window.last_colour_used});m.push({name:"cssdir",value:TVE_Content_Builder.config.editor_dir});c.post(TVE_Content_Builder.config.shortcodes_dir+n+".php",c.param(m),function(p){k.insert(p,o);TVE_Editor_Page.overlay("close")});return false},before_fetch:function(n,l,m){if(l.hasClass("user_template_item")){this.load_template(jQuery.trim(l.find(".tve_left").text()),m);return false}return true},after_fetch:function(l){if(l.hasClass("thrv_content_container_shortcode")){l.parent().addClass("tve_clearfix")}else{if(l.hasClass("thrv_countdown_timer")){if(l.hasClass("tve_countdown_timer_evergreen")){l.tve_countdown_timer_evergreen().update()}else{l.tve_countdown_timer().update()}}else{if(l.find(".tve_vtabs").length){l.tve_tabs().resize()}else{if(l.is(".thrv_lead_generation")){l.tve_lead_generation().applyStyle("thrv_lead_generation_vertical")}}}}},insert:function(m,o,l){if(typeof l==="undefined"){l=false}c(".tve_dropzone").removeClass("tve_dragged_over");tve_set_window_content_before_action();var n=c(m);if(l){o.html(n);if(n.hasClass("tve_table")){n=n.parent()}}else{o.replaceWith(n);n.find(".tve_dropzone").each(function(){k.dropzone_events(this)});n.filter(".tve_dropzone").each(function(){k.dropzone_events(this)})}this.ensure_dropzones(n);this.bind_draggable(n);k.after_fetch(n);tve_set_window_content_after_action();return n},before_remove:function(l){if(l.next().is(".tve_dropzone")){l.next().remove()}},after_clone:function(l,m){m.find(".tve_dropzone").each(function(){k.dropzone_events(this)});this.bind_draggable(m);this.ensure_dropzones(l);this.ensure_dropzones(m)},load_template:function(m,n){m=encodeURIComponent(m);var l={action:"tve_load_user_template",template_name:m,security:tve_path_params.tve_ajax_nonce,dataType:"json"};TVE_Editor_Page.overlay();jQuery.post(tve_path_params.ajax_url,l,function(o){o=JSON.parse(o);c(".tve_dropzone").removeClass("tve_dragged_over");tve_set_window_content_before_action();var p=c(o.html_code);p=tve_provess_saved_template(o.css_code,p);n.replaceWith(p);k.bind_draggable(p);tve_set_window_content_after_action();k.refresh();TVE_Editor_Page.overlay("close")})},page_scroll:function(r){if(typeof r==="undefined"){r="body"}var q=c('<div id="tve_page_scroller_top" class="tve_window_drag_scroll"><span class="tve_arrow"></span><div class="tve_drag_events"></div></div>').appendTo(r),l=c('<div id="tve_page_scroller_bottom" class="tve_window_drag_scroll"><span class="tve_arrow"></span><div class="tve_drag_events"></div></div>').appendTo(r),o=q.add(l),p=null,n=null,m=function(v,t){if(typeof t==="undefined"){t=false}var u=q.parent();if(u.is("body")){u=c("body,html")}if(u.is(":animated")){return true}var s=u.is("body")?c(window).scrollTop():u.scrollTop();if(v==-1){l.removeClass("tve_scroll_hide");if(s==0){q.addClass("tve_scroll_hide").removeClass("tve_drag_hover")}else{q.removeClass("tve_scroll_hide")}}else{q.removeClass("tve_scroll_hide");if(s+c(window).height()>=c("body").height()-45){l.addClass("tve_scroll_hide").removeClass("tve_drag_hover")}else{l.removeClass("tve_scroll_hide")}}if(!t){u.animate({scrollTop:s+(v*120)},80,"linear")}return true};o.each(function(){var t=c(this),s=t.children(".tve_drag_events").get(0);e(s,"dragenter",function(){var v=c(this).parent(),u=v.is(q)?-1:1;clearInterval(n);p=u;n=setInterval(function(){m(u)},20);v.addClass("tve_drag_hover")});e(s,"dragleave",function(u){clearInterval(n);c(this).parent().removeClass("tve_drag_hover")})});m(-1,true);return{show:function(){o.show()},hide:function(){clearInterval(n);o.removeClass("tve_drag_hover tve_scroll_hide")}}}};TVE_Content_Builder.drag=k})(jQuery);