var TVE_Content_Builder=TVE_Content_Builder||{};(function(b){var e={start:"__TCB_EVENT_",end:"_TNEVE_BCT__"},c={},d=function(f,g,j,i){TVE_Editor_Page.overlay();var h={};b.each(g,function(m,l){h[m]=l});h.action="tve_event_manager";h.security=TVE_Content_Builder.config.tve_ajax_nonce;h.route=f;h.post_id=TVE_Content_Builder.config.post_id;jQuery.post(TVE_Content_Builder.config.ajax_url,h,function(k){if(typeof j!=="function"){a.lightbox(k)}else{j.call(a,k)}TVE_Editor_Page.overlay("close");b(a).trigger("tve-event-ajax-response",f,g);if(typeof i!=="undefined"&&i){return}h.previous_call=null;c=h})},a={$element:null,config:[],init_done:false,$lf:null,$lo:null,current_event:null,init:function(){if(this.init_done){return this}this.init_done=true;this.$lo=b("#tve_lightbox_overlay");this.$lf=b("#tve_lightbox_frame").on("click",".tve_event_onclick",function(){var g=b(this),f=g.attr("data-action");a[f](g)}).on("change",".tve_event_onchange",function(){var g=b(this),f=g.attr("data-action");a[f](g)});return this},locate_element:function(f){if(f.hasClass("thrv_button_shortcode")){this.$element=f.find(".tve_btnLink")}else{if(f.hasClass("thrv_calltoaction_shortcode")){this.$element=f.find(".tve_btnLink")}else{if(f.is(text_elements)){this.$element=f.find("a.tve_active_hyperlink")}else{if(f.hasClass("thrv_icon")){this.$element=f.find(".tve_sc_icon")}else{this.$element=f}}}}},open:function(f){this.init();this.locate_element(f);this.config_read();this.list()},close:function(){this.$lf.fadeOut();this.$lo.fadeOut()},add:function(){d("form",{});this.current_event=null},edit:function(f){this.current_event=f.attr("data-index");var g=this.config[this.current_event];g.edit_page=1;d("form",g)},remove:function(f){this.config.splice(parseInt(f.attr("data-index")),1);this.config_write();this.list()},save:function(){if(!TVE_Content_Builder.validator.isValid(this.$lf)){return}var f=this.get_event_settings();for(var g=0,h;h=this.config[g++];){if(h.t==f.t&&h.a==f.a&&g-1!=this.current_event){alert("An Event is already registered for this Trigger and Action. Please choose a different configuration.");return}}if(this.current_event){this.config[this.current_event]=f}else{this.config.push(f)}this.config_write();this.list()},list:function(){var f=this;d("list",{events:this.config},function(h){f.lightbox(h);var g=b("#tve_event_list_errors");if(g.length){g=g.val().split(",");for(var j=0,l;l=g[j++];){f.config[parseInt(l)]=null}var k=f.config;f.config=[];b.each(k,function(n,m){if(m!==null){f.config.push(m)}});f.config_write()}});this.current_event=null},get_event_settings:function(){return{t:this.$lf.find("#tve_event_trigger").val(),a:this.$lf.find("#tve_event_action").val(),config:this.$lf.find("#tve_event_settings").find("input,select,textarea").serializeObject()}},action_settings:function(h){var f=this.$lf.find("#tve_event_save"),g=h.val();d("settings",{event_action:g,event_trigger:b("#tve_event_trigger").val()},function(i){a.$lf.find("#tve_event_settings").html(i);a.$lf.find("#tve_event_settings").find(".tve_custom_event_action").click(function(){a.custom_action(b(this).attr("data-action"))});g&&f.show();!g&&f.hide()})},custom_action:function(g){switch(g){case"add_lightbox":var f=this.$lf.find("#tve_event_save"),h=b("#tve_event_action").val();d("add_lightbox",{previous_call:c},function(i){a.$lf.find("#tve_event_settings").html(i);a.$lf.find("#tve_event_settings").find(".tve_custom_event_action").click(function(){a.custom_action(b(this).attr("data-action"))});h&&f.show();!h&&f.hide()},true);break}},lightbox:function(f){this.$lf.find("#tve_lightbox_content").html(f);this.$lf.add(this.$lo).removeClass("tve_link_lightbox").fadeIn();this.$lf.find("#tve_lightbox_buttons").hide();return this},config_read:function(){this.config=this.$element.attr("data-tcb-events");this.config=this.config?JSON.parse(this.config.replace(e.start,"").replace(e.end,"")):[];b(this).trigger("tve-event-read",this.config,this.$element)},config_write:function(){if(this.config.length){this.$element.addClass("tve_evt_manager_listen")}else{this.$element.removeClass("tve_evt_manager_listen")}b(this).trigger("tve-event-write",[this.config,this.$element]);this.$element.attr("data-tcb-events",e.start+JSON.stringify(this.config)+e.end)}};TVE_Content_Builder.event_manager=a;b(TVE_Content_Builder.event_manager).bind("tve-event-write",function(m,h,g){var n=g,l=g.closest(".thrv_wrapper").length?g.closest(".thrv_wrapper"):g,k=function(o,q){var r=q.split(" "),p=[];b.each(r,function(t,s){if(s.indexOf("tve_et_")===0||s.indexOf("tve_ea_")===0||s.indexOf("tve_anim")===0){p.push(s)}});return p.join(" ")};n.removeClass(k);l.removeClass(k);for(var j=0,f;f=h[j++];){n.addClass("tve_et_"+f.t);l.addClass("tve_ea_"+f.a);if(f.a=="thrive_animation"){l.addClass("tve_anim_"+f.config.anim)}}})})(jQuery);